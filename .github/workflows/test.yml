name: PR Issue Comment Test

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  notifyIssueComment:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Check if self-comment
        id: check_self_comment
        run: |
          PR_AUTHOR=$(gh api "repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}" --jq '.user.login')
          COMMENTER="${{ github.actor }}"

          if [[ "$PR_AUTHOR" == "$COMMENTER" ]]; then
            echo "is_self_comment=true" >> $GITHUB_OUTPUT
            echo "Skip notification for self-comment"
          else
            echo "is_self_comment=false" >> $GITHUB_OUTPUT
          fi

      - name: Get commenter Slack ID
        if: steps.check_self_comment.outputs.is_self_comment != 'true'
        id: get_slack_id
        run: |
          COMMENTER="${{ github.actor }}"
          SLACK_ID=$(cat .github/workflows/reviewers.json | jq -r --arg user "$COMMENTER" '.[] | select(.github_username == $user).slack_id')
          echo "slack_id=$SLACK_ID" >> $GITHUB_OUTPUT

      - name: Send Slack DM
        if: steps.check_self_comment.outputs.is_self_comment != 'true' && steps.get_slack_id.outputs.slack_id != ''
        run: |
          # DM 채널 생성/얻기
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.SLACK_OAUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data "{\"users\": \"${{ steps.get_slack_id.outputs.slack_id }}\"}" \
            "https://slack.com/api/conversations.open")
            
          CHANNEL_ID=$(echo $RESPONSE | jq -r '.channel.id')

          # 간단한 메시지 보내기
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.SLACK_OAUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"channel\": \"$CHANNEL_ID\",
              \"text\": \"🔔 PR에 새로운 댓글을 작성하셨네요!\"
            }" \
            "https://slack.com/api/chat.postMessage"
